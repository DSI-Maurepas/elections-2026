const S={COMMUNE_NAME:"Maurepas",COMMUNE_CODE:"78403",COMMUNE_POP:2e4,ELECTION_DATE_T1:"2026-03-15",ELECTION_DATE_T2:"2026-03-22",VOTING_HOURS_START:"08:00",VOTING_HOURS_END:"20:00",SEATS_MUNICIPAL_TOTAL:35,SEATS_COMMUNITY_TOTAL:6,SEATS_THRESHOLD_PCT:5},f={CREATE:"CREATE",UPDATE:"UPDATE",DELETE:"DELETE",VALIDATE:"VALIDATE",CALCULATE:"CALCULATE",CONFIG:"CONFIG",EXPORT:"EXPORT"},R={INFO:"INFO",WARNING:"WARNING",ERROR:"ERROR",CRITICAL:"CRITICAL"},g={SCOPES:["https://www.googleapis.com/auth/spreadsheets"]},p={AUTH_TOKEN:"elections_auth_token",USER_EMAIL:"elections_user_email",USER_PREFS:"elections_user_prefs",LAST_SYNC:"elections_last_sync"},d={CONFIG:"Config",ELECTIONS_STATE:"ElectionsState"};class A{constructor(){this.clientId="702016125879-8t5lau13b7mvifl4ttp2drh2v6871ad4.apps.googleusercontent.com",this.scopes=g.SCOPES.join(" "),this.tokenClient=null,this.accessToken=null}async initialize(){return new Promise((s,e)=>{const t=document.createElement("script");t.src="https://accounts.google.com/gsi/client",t.onload=()=>{this.tokenClient=google.accounts.oauth2.initTokenClient({client_id:this.clientId,scope:this.scopes,callback:a=>{if(a.error){e(a);return}this.handleAuthResponse(a),s(a)}}),s()},t.onerror=e,document.head.appendChild(t)})}async signIn(){return this.tokenClient||await this.initialize(),new Promise((s,e)=>{try{this.tokenClient.callback=t=>{if(t.error){e(t);return}this.handleAuthResponse(t),s(t)},this.tokenClient.requestAccessToken({prompt:""})}catch(t){e(t)}})}handleAuthResponse(s){this.accessToken=s.access_token,localStorage.setItem(p.AUTH_TOKEN,s.access_token);const e=s.expires_in||3600,t=Date.now()+e*1e3;localStorage.setItem("auth_token_expires_at",t.toString())}signOut(){var e,t;const s=this.accessToken||localStorage.getItem(p.AUTH_TOKEN);s&&((t=(e=window.google)==null?void 0:e.accounts)!=null&&t.oauth2)&&google.accounts.oauth2.revoke(s),this.accessToken=null,localStorage.removeItem(p.AUTH_TOKEN),localStorage.removeItem("auth_token_expires_at"),localStorage.removeItem(p.USER_EMAIL)}isAuthenticated(){const s=localStorage.getItem(p.AUTH_TOKEN),e=localStorage.getItem("auth_token_expires_at");return!s||!e?!1:Date.now()>parseInt(e)?(this.signOut(),!1):(this.accessToken=s,!0)}getAccessToken(){return this.isAuthenticated()?this.accessToken||localStorage.getItem(p.AUTH_TOKEN):null}async refreshTokenIfNeeded(){const s=localStorage.getItem("auth_token_expires_at");if(!s)return;const e=Date.now();if(parseInt(s)-e<5*60*1e3)try{await this.signIn()}catch(a){throw console.error("Erreur lors du rafraîchissement du token:",a),a}}async getUserInfo(){const s=this.getAccessToken();if(!s)throw new Error("Non authentifié");try{const e=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${s}`}});if(!e.ok)throw new Error("Erreur lors de la récupération des informations utilisateur");const t=await e.json();return localStorage.setItem(p.USER_EMAIL,t.email),t}catch(e){throw console.error("Erreur getUserInfo:",e),e}}getUserEmail(){return localStorage.getItem(p.USER_EMAIL)||"utilisateur@inconnu.com"}}const E=new A;class m{constructor(){this.spreadsheetId="1k0ZHelPxIUdgSXbUekhWGIt49Sjrq_Y4IgEB9K1FZP0",this.apiUrl="https://sheets.googleapis.com/v4/spreadsheets",this._inflight=new Map,this._cache=new Map,this._cacheTtlMs=800}colIndexToA1(s){let e=s+1,t="";for(;e>0;){const a=(e-1)%26;t=String.fromCharCode(65+a)+t,e=Math.floor((e-1)/26)}return t}parseSheetValue(s){if(s==null||typeof s!="string")return s;const e=s.trim();if(e==="TRUE")return!0;if(e==="FALSE")return!1;if(e!==""&&!Number.isNaN(Number(e)))return Number(e);if(e.startsWith("[")&&e.endsWith("]")||e.startsWith("{")&&e.endsWith("}"))try{return JSON.parse(e)}catch{return s}return s}a1(s,e="A:Z"){return`'${String(s||"").replace(/'/g,"''")}'!${e}`}async sleep(s){return new Promise(e=>setTimeout(e,s))}async makeRequest(s,e={},t=0){var o,u,h;if(!this.spreadsheetId)throw new Error("Configuration manquante: VITE_SPREADSHEET_ID non défini");try{await((o=E.refreshTokenIfNeeded)==null?void 0:o.call(E))}catch(c){console.warn("Avertissement: refreshTokenIfNeeded a échoué:",c)}const a=(u=E.getAccessToken)==null?void 0:u.call(E);if(!a)throw new Error("Non authentifié - Token manquant");const n=`${this.apiUrl}/${this.spreadsheetId}${s}`,i={Authorization:`Bearer ${a}`,"Content-Type":"application/json",...e.headers||{}},r=await fetch(n,{...e,headers:i});if(r.status===429&&t<3){const c=r.headers.get("retry-after"),l=c?parseInt(c,10)*1e3:300*2**t;return await this.sleep(l),this.makeRequest(s,e,t+1)}if(!r.ok){let c="Erreur API Google Sheets";try{const I=await r.json();c=((h=I==null?void 0:I.error)==null?void 0:h.message)||c}catch{try{const T=await r.text();T&&(c=T)}catch{}}const l=new Error(`${c} (HTTP ${r.status})`);throw l.status=r.status,l}return r.status===204?null:await r.json()}_getCached(s){const e=this._cache.get(s);return e?Date.now()-e.at>this._cacheTtlMs?(this._cache.delete(s),null):e.data:null}_setCached(s,e){this._cache.set(s,{at:Date.now(),data:e})}async _dedup(s,e){const t=this._inflight.get(s);if(t)return t;const a=(async()=>{try{return await e()}finally{this._inflight.delete(s)}})();return this._inflight.set(s,a),a}async getValues(s){var n;const e=`/values:batchGet?ranges=${encodeURIComponent(s)}`,t=await this.makeRequest(e),a=(n=t==null?void 0:t.valueRanges)==null?void 0:n[0];return(a==null?void 0:a.values)||[]}_transformRows(s,e){if(!e||e.length===0)return[];switch(s){case"Bureaux":return e.map(t=>({id:t[0]||"",nom:t[1]||"",adresse:t[2]||"",president:t[3]||"",secretaire:t[4]||"",secretaireSuppleant:t[5]||"",inscrits:parseInt(t[6])||0,actif:t[7]==="TRUE"||t[7]===!0}));case"Candidats":return e.map(t=>({listeId:t[0]||"",nomListe:t[1]||"",teteListeNom:t[2]||"",teteListePrenom:t[3]||"",couleur:t[4]||"#0055A4",ordre:parseInt(t[5])||0,actifT1:t[6]==="TRUE"||t[6]===!0,actifT2:t[7]==="TRUE"||t[7]===!0}));case"Participation_T1":case"Participation_T2":return e.map(t=>({bureauId:t[0]||"",tour:parseInt(t[1])||1,inscrits:parseInt(t[2])||0,votants08h:parseInt(t[3])||0,votants09h:parseInt(t[4])||0,votants10h:parseInt(t[5])||0,votants11h:parseInt(t[6])||0,votants12h:parseInt(t[7])||0,votants13h:parseInt(t[8])||0,votants14h:parseInt(t[9])||0,votants15h:parseInt(t[10])||0,votants16h:parseInt(t[11])||0,votants17h:parseInt(t[12])||0,votants18h:parseInt(t[13])||0,votants19h:parseInt(t[14])||0,votants20h:parseInt(t[15])||0,timestamp:t[16]||""}));case"Resultats_T1":case"Resultats_T2":return e.map(t=>({bureauId:t[0]||"",votants:parseInt(t[1])||0,blancs:parseInt(t[2])||0,nuls:parseInt(t[3])||0,exprimes:parseInt(t[4])||0,voix:t[5]?JSON.parse(t[5]):{},timestamp:t[6]||""}));default:return e}}async getData(s,e={}){const t=(e==null?void 0:e.range)||"A:Z",a=this.a1(s,t),n=`getData:${a}`,i=this._getCached(n);return i||await this._dedup(n,async()=>{const o=(await this.getValues(a)).slice();o.length>0&&o.shift();const h=this._transformRows(s,o).map((c,l)=>({...c,rowIndex:l}));return this._setCached(n,h),h})}async appendRow(s,e){const t=Array.isArray(e)?e:Object.values(e||{});return await this.appendRows(s,[t])}async updateRow(s,e,t){const a=Array.isArray(t)?t:Object.values(t||{}),n=Number(e)+2,i=this.colIndexToA1(Math.max(0,a.length-1)),r=this.a1(s,`A${n}:${i}${n}`);return this._cache.clear(),await this.makeRequest(`/values/${encodeURIComponent(r)}?valueInputOption=USER_ENTERED`,{method:"PUT",body:JSON.stringify({values:[a]})})}async deleteRow(s,e){const t=Number(e)+2,a=this.a1(s,`A${t}:Z${t}`);return this._cache.clear(),await this.makeRequest(`/values/${encodeURIComponent(a)}:clear`,{method:"POST"})}async batchUpdate(s,e){if(Array.isArray(s)&&e===void 0){const r=s.map(o=>({range:o.range,values:o.values}));return this._cache.clear(),await this.makeRequest("/values:batchUpdate",{method:"POST",body:JSON.stringify({valueInputOption:"USER_ENTERED",data:r})})}const t=s,n=(Array.isArray(e)?e:[]).map(i=>{const r=i.rowIndex??i.index??0,o=i.rowData??i.data??[],u=Array.isArray(o)?o:Object.values(o||{}),h=Number(r)+2,c=this.colIndexToA1(Math.max(0,u.length-1));return{range:this.a1(t,`A${h}:${c}${h}`),values:[u]}});return await this.batchUpdate(n)}async getConfig(){const s=this.a1(d.CONFIG,"A:B"),e=`getConfig:${s}`,t=this._getCached(e);return t||await this._dedup(e,async()=>{const a=await this.getValues(s),n={};return a.forEach(([i,r])=>{i&&(n[i]=this.parseSheetValue(r))}),this._setCached(e,n),n})}async getElectionState(){const s=this.a1(d.ELECTIONS_STATE,"A:C"),e=`getElectionState:${s}`,t=this._getCached(e);return t||await this._dedup(e,async()=>{const n=(await this.getValues(s)).slice();n.length>0&&String(n[0][0]).toLowerCase().includes("key")&&n.shift();const i={};return n.forEach(([r,o])=>{r&&(i[r]=this.parseSheetValue(o))}),this._setCached(e,i),i})}async updateElectionState(s,e){if(s&&typeof s=="object"&&!Array.isArray(s)){for(const[c,l]of Object.entries(s))await this.updateElectionState(c,l);return}const t=s,a=this.a1(d.ELECTIONS_STATE,"A:C"),n=await this.getValues(a),i=n.length>0&&String(n[0][0]).toLowerCase().includes("key")?1:0,r=n.slice(i).findIndex(([c])=>c===t),o=new Date().toISOString();if(this._cache.clear(),r===-1)return await this.appendRows(d.ELECTIONS_STATE,[[t,e,o]]);const u=r+i+1,h=this.a1(d.ELECTIONS_STATE,`B${u}:C${u}`);return await this.makeRequest(`/values/${encodeURIComponent(h)}?valueInputOption=USER_ENTERED`,{method:"PUT",body:JSON.stringify({values:[[e,o]]})})}async appendRows(s,e){const t=this.a1(s,"A:Z");return this._cache.clear(),await this.makeRequest(`/values/${encodeURIComponent(t)}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`,{method:"POST",body:JSON.stringify({values:e})})}async clearSheet(s){const e=this.a1(s,"A:Z");return this._cache.clear(),await this.makeRequest(`/values/${encodeURIComponent(e)}:clear`,{method:"POST"})}}const C=new m;export{f as A,S as E,R as S,E as a,C as g};
