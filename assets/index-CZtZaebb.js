import{r as m,a as W,R as X}from"./react-vendor-wGySg1uH.js";import{a as P,g as w,A as $,S as O,E as k}from"./google-api-C85ACnha.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const i of t)if(i.type==="childList")for(const u of i.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&a(u)}).observe(document,{childList:!0,subtree:!0});function r(t){const i={};return t.integrity&&(i.integrity=t.integrity),t.referrerPolicy&&(i.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?i.credentials="include":t.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(t){if(t.ep)return;t.ep=!0;const i=r(t);fetch(t.href,i)}})();var H={exports:{}},D={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Z=m,ee=Symbol.for("react.element"),se=Symbol.for("react.fragment"),te=Object.prototype.hasOwnProperty,ae=Z.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,re={key:!0,ref:!0,__self:!0,__source:!0};function J(l,s,r){var a,t={},i=null,u=null;r!==void 0&&(i=""+r),s.key!==void 0&&(i=""+s.key),s.ref!==void 0&&(u=s.ref);for(a in s)te.call(s,a)&&!re.hasOwnProperty(a)&&(t[a]=s[a]);if(l&&l.defaultProps)for(a in s=l.defaultProps,s)t[a]===void 0&&(t[a]=s[a]);return{$$typeof:ee,type:l,key:i,ref:u,props:t,_owner:ae.current}}D.Fragment=se;D.jsx=J;D.jsxs=J;H.exports=D;var e=H.exports,B={},U=W;B.createRoot=U.createRoot,B.hydrateRoot=U.hydrateRoot;class ie{isAuthenticated(){try{return!!P.getAccessToken()}catch{return!1}}async log(s,r,a,t={},i={}){if(!this.isAuthenticated()){console.warn("AuditService: action non journalis√©e (token manquant).",{action:s,entity:r,entityId:a});return}try{await w.logAudit(s,r,a,t,i)}catch(u){console.error("Erreur lors de l'enregistrement dans l'audit:",u)}}async logError(s,r,a,t="",i={}){if(!this.isAuthenticated()){console.warn("AuditService: erreur non journalis√©e (token manquant).",{severity:s,source:r,message:a,context:i});return}try{await w.logError(s,r,a,t,i)}catch(u){console.error("Erreur lors de l'enregistrement de l'erreur:",u)}}async logCreate(s,r,a){return this.log($.CREATE,s,r,{},a)}async logUpdate(s,r,a,t){return this.log($.UPDATE,s,r,a,t)}async logDelete(s,r,a){return this.log($.DELETE,s,r,a,{})}async logValidate(s,r,a){return this.log($.VALIDATE,s,r,{},a)}async logCalculate(s,r,a){return this.log($.CALCULATE,s,r,{},a)}async logConfig(s,r,a,t){return this.log($.CONFIG,s,r,a,t)}async logExport(s,r,a){return this.log($.EXPORT,s,r,{},a)}async logInfo(s,r,a={}){return this.logError(O.INFO,s,r,"",a)}async logWarning(s,r,a={}){return this.logError(O.WARNING,s,r,"",a)}async logCritical(s,r,a,t={}){return this.logError(O.CRITICAL,s,r,a,t)}setupGlobalErrorHandler(){window.addEventListener("error",s=>{var r;this.logError(O.ERROR,"GlobalErrorHandler",s.message,((r=s.error)==null?void 0:r.stack)||"",{filename:s.filename,lineno:s.lineno,colno:s.colno})}),window.addEventListener("unhandledrejection",s=>{var r,a;this.logError(O.ERROR,"UnhandledPromiseRejection",((r=s.reason)==null?void 0:r.message)||String(s.reason),((a=s.reason)==null?void 0:a.stack)||"",{promise:String(s.promise)})})}}const L=new ie,R=()=>{const[l,s]=m.useState({tourActuel:1,tour1Verrouille:!1,tour2Verrouille:!1,dateT1:"2026-03-15",dateT2:"2026-03-22",candidatsQualifies:[],loading:!0,error:null}),r=()=>{const n=P.getAccessToken();if(!n){const c=new Error("Non authentifi√© - Token manquant");throw c.code="AUTH_REQUIRED",c}return n},a=m.useCallback(async()=>{try{s(c=>({...c,loading:!0,error:null})),r();const n=await w.getElectionState();s({tourActuel:n.tourActuel??1,tour1Verrouille:n.tour1Verrouille??!1,tour2Verrouille:n.tour2Verrouille??!1,dateT1:n.dateT1||"2026-03-15",dateT2:n.dateT2||"2026-03-22",candidatsQualifies:Array.isArray(n.candidatsQualifies)?n.candidatsQualifies:n.candidatsQualifies?[n.candidatsQualifies]:[],loading:!1,error:null})}catch(n){if(console.error("Erreur chargement √©tat √©lection:",n),n.code==="AUTH_REQUIRED"){s(c=>({...c,loading:!1,error:null}));return}s(c=>({...c,loading:!1,error:n.message}))}},[]),t=m.useCallback(async n=>{try{if(r(),!Array.isArray(n)||n.length!==2)throw new Error("Exactement 2 candidats doivent √™tre qualifi√©s");await w.updateElectionState({tourActuel:2,tour1Verrouille:!0,candidatsQualifies:JSON.stringify(n)}),await L.log("PASSAGE_T2","ELECTION","STATE",{},{candidats:n.map(c=>c.nom||c.nomListe||c.listeId)}),await a()}catch(c){throw console.error("Erreur passage T2:",c),c}},[a]),i=m.useCallback(async n=>{try{r();const c=n===1?"tour1Verrouille":"tour2Verrouille";await w.updateElectionState({[c]:!0}),await L.log("VERROUILLAGE","ELECTION","STATE",{},{tour:n}),await a()}catch(c){throw console.error("Erreur verrouillage:",c),c}},[a]),u=m.useCallback(async n=>{try{r();const c=n===1?"tour1Verrouille":"tour2Verrouille";await w.updateElectionState({[c]:!1}),await L.log("DEVERROUILLAGE","ELECTION","STATE",{},{tour:n}),await a()}catch(c){throw console.error("Erreur d√©verrouillage:",c),c}},[a]);return m.useEffect(()=>{P.getAccessToken()?a():s(n=>({...n,loading:!1}))},[a]),{state:l,loadState:a,passerSecondTour:t,verrouillerTour:i,deverrouillerTour:u}},ne=({currentPage:l,onNavigate:s})=>{const{state:r}=R(),{tourActuel:a,tour1Verrouille:t,tour2Verrouille:i}=r,u=[{id:"dashboard",label:"üìä Tableau de bord",page:"dashboard",always:!0},{id:"participation",label:"üìã Participation",page:"participation",show:!0},{id:"resultats",label:"üó≥Ô∏è R√©sultats",page:"resultats",show:!0},{id:"passage-t2",label:"‚û°Ô∏è Passage T2",page:"passage-t2",show:a===1&&!t},{id:"sieges",label:"ü™ë Si√®ges",page:"sieges",show:a===1&&t||a===2&&i},{id:"exports",label:"üìÑ Exports",page:"exports",show:!0},{id:"admin",label:"‚öôÔ∏è Administration",page:"admin",show:!0}];return e.jsxs("nav",{className:"main-navigation",children:[e.jsxs("div",{className:"nav-header",children:[e.jsx("h1",{children:"üó≥Ô∏è √âlections Municipales 2026"}),e.jsxs("div",{className:"election-status",children:[e.jsx("span",{className:`tour-badge tour-${a}`,children:a===1?"1er Tour":"2nd Tour"}),a===1&&e.jsx("span",{className:`lock-status ${t?"locked":"unlocked"}`,children:t?"üîí Verrouill√©":"üîì En cours"}),a===2&&e.jsx("span",{className:`lock-status ${i?"locked":"unlocked"}`,children:i?"üîí Verrouill√©":"üîì En cours"})]})]}),e.jsx("ul",{className:"nav-menu",children:u.filter(n=>n.always||n.show).map(n=>e.jsx("li",{children:e.jsx("button",{className:`nav-item ${l===n.page?"active":""}`,onClick:()=>s(n.page),children:n.label})},n.id))}),e.jsx("div",{className:"nav-info",children:e.jsxs("p",{className:"election-dates",children:[e.jsx("strong",{children:"1er tour :"})," Dimanche 15 mars 2026",e.jsx("br",{}),e.jsx("strong",{children:"2nd tour :"})," Dimanche 22 mars 2026",e.jsx("br",{}),e.jsx("strong",{children:"Horaires :"})," 08h00 - 20h00"]})})]})},le=()=>{const l=new Date().getFullYear();return e.jsxs("footer",{className:"main-footer",children:[e.jsxs("div",{className:"footer-content",children:[e.jsxs("div",{className:"footer-section",children:[e.jsx("h4",{children:"‚öñÔ∏è Conformit√© l√©gale"}),e.jsxs("p",{children:["Application conforme au Code √©lectoral fran√ßais",e.jsx("br",{}),"√âlections municipales et communautaires",e.jsx("br",{}),"D√©cret n¬∞ 2001-213 du 8 mars 2001"]})]}),e.jsxs("div",{className:"footer-section",children:[e.jsx("h4",{children:"üìû Support technique"}),e.jsxs("p",{children:["DSI - Mairie",e.jsx("br",{}),"En cas de probl√®me le jour du scrutin :",e.jsx("br",{}),e.jsx("strong",{children:"Contactez imm√©diatement le DSI"})]})]}),e.jsxs("div",{className:"footer-section",children:[e.jsx("h4",{children:"üîê S√©curit√© & Tra√ßabilit√©"}),e.jsxs("p",{children:["Toutes les actions sont trac√©es",e.jsx("br",{}),"Audit complet disponible",e.jsx("br",{}),"Donn√©es s√©curis√©es (Google Sheets API)"]})]}),e.jsxs("div",{className:"footer-section",children:[e.jsx("h4",{children:"‚ÑπÔ∏è Informations"}),e.jsxs("p",{children:["Version 1.0.0",e.jsx("br",{}),"React 18 + Vite",e.jsx("br",{}),"13 bureaux de vote configur√©s"]})]})]}),e.jsx("div",{className:"footer-bottom",children:e.jsxs("p",{children:["¬© ",l," - Mairie - Tous droits r√©serv√©s",e.jsx("br",{}),"Application d√©velopp√©e pour les √©lections municipales du 15 mars 2026"]})})]})},y=l=>{const[s,r]=m.useState([]),[a,t]=m.useState(!1),[i,u]=m.useState(null),n=m.useRef({}),c=m.useRef(null),d=m.useCallback(async(g={})=>{n.current=g||{};try{t(!0),u(null);const f=await w.getData(l,g);return r(f),f}catch(f){throw console.error(`Erreur chargement ${l}:`,f),u(f.message),f}finally{t(!1)}},[l]),h=m.useCallback(()=>{c.current&&clearTimeout(c.current),c.current=setTimeout(()=>{d(n.current)},250)},[d]);m.useEffect(()=>{const g=f=>{var j;const N=(j=f==null?void 0:f.detail)==null?void 0:j.sheetName;N&&N===l&&h()};return window.addEventListener("sheets:changed",g),()=>{window.removeEventListener("sheets:changed",g),c.current&&clearTimeout(c.current)}},[l,h]);const o=m.useCallback(async g=>{try{t(!0),u(null);const f=await w.appendRow(l,g);return await d(),f}catch(f){throw console.error(`Erreur cr√©ation ${l}:`,f),u(f.message),f}finally{t(!1)}},[l,d]),x=m.useCallback(async(g,f)=>{try{t(!0),u(null);const N=await w.updateRow(l,g,f);return await d(),N}catch(N){throw console.error(`Erreur mise √† jour ${l}:`,N),u(N.message),N}finally{t(!1)}},[l,d]),p=m.useCallback(async g=>{try{t(!0),u(null),await w.deleteRow(l,g),await d()}catch(f){throw console.error(`Erreur suppression ${l}:`,f),u(f.message),f}finally{t(!1)}},[l,d]),v=m.useCallback(async g=>{try{t(!0),u(null);const f=await w.batchUpdate(l,g);return await d(),f}catch(f){throw console.error(`Erreur batch update ${l}:`,f),u(f.message),f}finally{t(!1)}},[l,d]),E=m.useCallback(async()=>d(),[d]),S=m.useCallback(()=>{u(null)},[]);return{data:s,loading:a,error:i,load:d,create:o,update:x,remove:p,batchUpdate:v,refresh:E,clearError:S}};function Q({onNavigate:l}){const{state:s}=R(),{data:r,load:a}=y("Bureaux"),{data:t,load:i}=y("Candidats"),[u,n]=m.useState({totalInscrits:0,totalVotants:0,tauxParticipation:0,bureaux:0,candidats:0}),c=!!P.getAccessToken();m.useEffect(()=>{(async()=>{if(P.getAccessToken())try{const g=await w.getConfig();console.log("‚úÖ Google Sheets OK - Config:",g)}catch(g){console.error("‚ùå Sheets KO:",g)}})()},[]),m.useEffect(()=>{P.getAccessToken()&&(a(),i())},[a,i,c]),m.useEffect(()=>{n({bureaux:r.length,candidats:t.length,totalInscrits:0,totalVotants:0,tauxParticipation:0})},[r,t]);const{tourActuel:d,tour1Verrouille:h,tour2Verrouille:o,dateT1:x,dateT2:p}=s,v=new Date().toISOString().split("T")[0],E=v===x||v===p,S=v===x;return e.jsxs("div",{className:"dashboard",children:[e.jsxs("div",{className:"dashboard-header",children:[e.jsx("h2",{children:"üìä Tableau de bord"}),E&&e.jsxs("div",{className:`jour-scrutin-alert ${S?"tour1":"tour2"}`,children:["‚ö†Ô∏è ",e.jsx("strong",{children:"JOUR DU SCRUTIN"})," ‚Äì ",S?"1er tour":"2nd tour"]})]}),e.jsxs("div",{className:"dashboard-grid",children:[e.jsxs("div",{className:"dashboard-card election-state",children:[e.jsx("h3",{children:"üó≥Ô∏è √âtat de l'√©lection"}),e.jsxs("div",{className:"card-content",children:[e.jsxs("div",{className:"stat-row",children:[e.jsx("span",{className:"label",children:"Tour actuel :"}),e.jsx("span",{className:`value tour-badge tour-${d}`,children:d===1?"1er tour":"2nd tour"})]}),e.jsxs("div",{className:"stat-row",children:[e.jsx("span",{className:"label",children:"Statut :"}),e.jsx("span",{className:`value ${d===1&&h||d===2&&o?"locked":"active"}`,children:d===1&&h||d===2&&o?"üîí Verrouill√©":"üîì En cours"})]}),e.jsxs("div",{className:"stat-row",children:[e.jsx("span",{className:"label",children:"Date 1er tour :"}),e.jsx("span",{className:"value",children:new Date(x).toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"})})]}),e.jsxs("div",{className:"stat-row",children:[e.jsx("span",{className:"label",children:"Date 2nd tour :"}),e.jsx("span",{className:"value",children:new Date(p).toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"})})]})]})]}),e.jsxs("div",{className:"dashboard-card configuration",children:[e.jsx("h3",{children:"‚öôÔ∏è Configuration"}),e.jsxs("div",{className:"card-content",children:[e.jsxs("div",{className:"stat-row",children:[e.jsx("span",{className:"label",children:"Bureaux de vote :"}),e.jsx("span",{className:"value highlight",children:u.bureaux})]}),e.jsxs("div",{className:"stat-row",children:[e.jsxs("span",{className:"label",children:["Candidats (T",d,") :"]}),e.jsx("span",{className:"value highlight",children:u.candidats})]}),e.jsxs("div",{className:"stat-row",children:[e.jsx("span",{className:"label",children:"Horaires :"}),e.jsx("span",{className:"value",children:"08h00 ‚Äì 20h00"})]})]})]}),e.jsxs("div",{className:"dashboard-card participation",children:[e.jsx("h3",{children:"üìã Participation"}),e.jsxs("div",{className:"card-content",children:[e.jsxs("div",{className:"stat-row large",children:[e.jsx("span",{className:"label",children:"Taux :"}),e.jsxs("span",{className:"value participation-rate",children:[u.tauxParticipation.toFixed(2)," %"]})]}),e.jsx("button",{className:"action-btn primary",onClick:()=>l("participation"),disabled:!c,title:c?"":"Connexion requise",children:"üìã Saisir la participation"})]})]}),e.jsxs("div",{className:"dashboard-card actions",children:[e.jsx("h3",{children:"‚ö° Actions rapides"}),e.jsxs("div",{className:"card-content",children:[!h&&d===1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>l("participation"),className:"action-btn",disabled:!c,title:c?"":"Connexion requise",children:"üìã Participation"}),e.jsx("button",{onClick:()=>l("resultats"),className:"action-btn",disabled:!c,title:c?"":"Connexion requise",children:"üó≥Ô∏è R√©sultats"})]}),h&&d===1&&e.jsx("button",{onClick:()=>l("passage-t2"),className:"action-btn primary",disabled:!c,title:c?"":"Connexion requise",children:"‚û°Ô∏è G√©n√©rer le 2nd tour"}),d===2&&!o&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>l("participation"),className:"action-btn",disabled:!c,title:c?"":"Connexion requise",children:"üìã Participation T2"}),e.jsx("button",{onClick:()=>l("resultats"),className:"action-btn",disabled:!c,title:c?"":"Connexion requise",children:"üó≥Ô∏è R√©sultats T2"})]}),(h&&d===1||o&&d===2)&&e.jsx("button",{onClick:()=>l("sieges"),className:"action-btn success",disabled:!c,title:c?"":"Connexion requise",children:"ü™ë Calcul des si√®ges"}),e.jsx("button",{onClick:()=>l("exports"),className:"action-btn",disabled:!c,title:c?"":"Connexion requise",children:"üìÑ Exports"}),e.jsx("button",{onClick:()=>l("admin"),className:"action-btn",disabled:!c,title:c?"":"Connexion requise",children:"‚öôÔ∏è Administration"})]})]})]}),e.jsxs("div",{className:"dashboard-alerts",children:[!E&&e.jsxs("div",{className:"alert info",children:["‚ÑπÔ∏è Les bureaux ouvrent √† ",e.jsx("strong",{children:"08h00"})," le jour du scrutin"]}),E&&e.jsxs("div",{className:"alert warning",children:["‚ö†Ô∏è ",e.jsx("strong",{children:"Jour du scrutin"})," ‚Äì toutes les actions sont trac√©es"]})]})]})}const oe=()=>{const{state:l}=R(),{data:s,load:r}=y("Bureaux"),{data:a,load:t,create:i,update:u}=y(l.tourActuel===1?"Participation_T1":"Participation_T2"),[n,c]=m.useState(""),[d,h]=m.useState(0),[o,x]=m.useState({"08h":0,"10h":0,"12h":0,"14h":0,"16h":0,"18h":0,"20h":0}),[p,v]=m.useState(!1),[E,S]=m.useState(null);m.useEffect(()=>{r(),t()},[r,t]),m.useEffect(()=>{if(n&&s.length>0){const N=s.find(j=>j.id===n);if(N){h(N.inscrits||0);const j=a.find(C=>C.bureauId===n);j&&x({"08h":j.votants08h||0,"10h":j.votants10h||0,"12h":j.votants12h||0,"14h":j.votants14h||0,"16h":j.votants16h||0,"18h":j.votants18h||0,"20h":j.votants20h||0})}}},[n,s,a]);const g=(N,j)=>{const C=parseInt(j)||0;if(C>d){S({type:"error",text:`Le nombre de votants ne peut pas d√©passer ${d} inscrits`});return}const I=["08h","10h","12h","14h","16h","18h","20h"],b=I.indexOf(N);if(b>0){const T=I[b-1];if(C<o[T]){S({type:"error",text:"Les votants doivent √™tre cumulatifs (croissants)"});return}}x(T=>({...T,[N]:C})),S(null)},f=async N=>{if(N.preventDefault(),!n){S({type:"error",text:"Veuillez s√©lectionner un bureau"});return}try{v(!0),S(null);const j={bureauId:n,tour:l.tourActuel,inscrits:d,votants08h:o["08h"],votants10h:o["10h"],votants12h:o["12h"],votants14h:o["14h"],votants16h:o["16h"],votants18h:o["18h"],votants20h:o["20h"],timestamp:new Date().toISOString()},C=a.find(I=>I.bureauId===n);C?(await u(C.rowIndex,j),await L.log("UPDATE_PARTICIPATION",{bureau:n,tour:l.tourActuel})):(await i(j),await L.log("CREATE_PARTICIPATION",{bureau:n,tour:l.tourActuel})),S({type:"success",text:"Participation enregistr√©e avec succ√®s"}),await t(),window.dispatchEvent(new CustomEvent("sheets:changed",{detail:{sheetName:l.tourActuel===1?"Participation_T1":"Participation_T2",bureauId:n,ts:Date.now()}}))}catch(j){console.error("Erreur enregistrement:",j),S({type:"error",text:`Erreur : ${j.message}`})}finally{v(!1)}};return e.jsxs("div",{className:"participation-saisie",children:[e.jsxs("h2",{children:["üìã Saisie de la participation - Tour ",l.tourActuel]}),e.jsxs("form",{onSubmit:f,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Bureau de vote :"}),e.jsxs("select",{value:n,onChange:N=>c(N.target.value),required:!0,children:[e.jsx("option",{value:"",children:"-- S√©lectionner un bureau --"}),s.map(N=>e.jsxs("option",{value:N.id,children:[N.nom," (",N.inscrits," inscrits)"]},N.id))]})]}),n&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"inscrits-info",children:[e.jsx("strong",{children:"Inscrits :"})," ",d.toLocaleString("fr-FR")]}),e.jsxs("div",{className:"votants-grid",children:[e.jsx("h3",{children:"Votants cumul√©s par heure :"}),["08h","10h","12h","14h","16h","18h","20h"].map(N=>e.jsxs("div",{className:"votants-row",children:[e.jsxs("label",{children:[N," :"]}),e.jsx("input",{type:"number",min:"0",max:d,value:o[N],onChange:j=>g(N,j.target.value)}),e.jsxs("span",{className:"percentage",children:[d>0?(o[N]/d*100).toFixed(2):0,"%"]})]},N))]}),E&&e.jsx("div",{className:`message ${E.type}`,children:E.text}),e.jsx("div",{className:"form-actions",children:e.jsx("button",{type:"submit",className:"btn-primary",disabled:p,children:p?"Enregistrement...":"üíæ Enregistrer"})})]})]})]})},ce=()=>{const{state:l}=R(),{data:s,load:r}=y("Bureaux"),{data:a,load:t}=y(l.tourActuel===1?"Participation_T1":"Participation_T2"),[i,u]=m.useState({inscrits:0,"08h":0,"09h":0,"10h":0,"11h":0,"12h":0,"13h":0,"14h":0,"15h":0,"16h":0,"17h":0,"18h":0,"19h":0,"20h":0});m.useEffect(()=>{r(),t()},[r,t]),m.useEffect(()=>{const h=a.reduce((o,x)=>({inscrits:o.inscrits+(x.inscrits||0),"08h":o["08h"]+(x.votants08h||0),"09h":o["09h"]+(x.votants09h||0),"10h":o["10h"]+(x.votants10h||0),"11h":o["11h"]+(x.votants11h||0),"12h":o["12h"]+(x.votants12h||0),"13h":o["13h"]+(x.votants13h||0),"14h":o["14h"]+(x.votants14h||0),"15h":o["15h"]+(x.votants15h||0),"16h":o["16h"]+(x.votants16h||0),"17h":o["17h"]+(x.votants17h||0),"18h":o["18h"]+(x.votants18h||0),"19h":o["19h"]+(x.votants19h||0),"20h":o["20h"]+(x.votants20h||0)}),{inscrits:0,"08h":0,"09h":0,"10h":0,"11h":0,"12h":0,"13h":0,"14h":0,"15h":0,"16h":0,"17h":0,"18h":0,"19h":0,"20h":0});u(h)},[a]);const n=h=>a.find(o=>o.bureauId===h),c=(h,o)=>o?(h/o*100).toFixed(2):0,d=["08h","09h","10h","11h","12h","13h","14h","15h","16h","17h","18h","19h","20h"];return e.jsxs("div",{className:"participation-tableau",children:[e.jsxs("h2",{children:["üìä Consolidation de la participation - Tour ",l.tourActuel]}),e.jsx("div",{className:"tableau-scroll",children:e.jsxs("table",{className:"participation-table participation-table--compact",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"bureau-col",children:"Bureau"}),e.jsx("th",{className:"inscrits-col",children:"Inscrits"}),d.map(h=>e.jsx("th",{className:"hour-col",children:h},h))]})}),e.jsx("tbody",{children:s.map((h,o)=>{const x=n(h.id),p=h.inscrits||0;return e.jsxs("tr",{className:x?"has-data":"no-data",children:[e.jsx("td",{className:"bureau-name",children:h.nom}),e.jsx("td",{className:"number",children:p.toLocaleString("fr-FR")}),d.map(v=>{const E=`votants${v}`,S=(x==null?void 0:x[E])||0,g=c(S,p);return e.jsxs("td",{className:"hour-cell",children:[e.jsx("div",{className:"hour-votants",children:S.toLocaleString("fr-FR")}),e.jsxs("div",{className:"hour-percent",children:[g,"%"]})]},`${h.id}-${v}`)})]},h.id??`${h.nom}-${o}`)})}),e.jsx("tfoot",{children:e.jsxs("tr",{className:"total-row has-data",children:[e.jsx("td",{children:e.jsx("strong",{children:"TOTAL COMMUNAL"})}),e.jsx("td",{className:"number",children:e.jsx("strong",{children:i.inscrits.toLocaleString("fr-FR")})}),d.map(h=>e.jsxs("td",{className:"hour-cell",children:[e.jsx("div",{className:"hour-votants",children:e.jsx("strong",{children:(i[h]||0).toLocaleString("fr-FR")})}),e.jsx("div",{className:"hour-percent",children:e.jsxs("strong",{children:[c(i[h]||0,i.inscrits),"%"]})})]},`total-${h}`))]})})]})}),e.jsxs("div",{className:"legend",children:[e.jsxs("p",{children:[e.jsx("span",{className:"legend-item has-data",children:"‚ñ†"})," Bureau avec donn√©es saisies"]}),e.jsxs("p",{children:[e.jsx("span",{className:"legend-item no-data",children:"‚ñ†"})," Bureau en attente de saisie"]})]})]})},de=()=>{var u,n,c,d,h,o;const{state:l}=R(),{data:s}=y("Bureaux"),{data:r,load:a}=y(l.tourActuel===1?"Participation_T1":"Participation_T2"),[t,i]=m.useState({totalInscrits:0,totalVotants:0,tauxParticipation:0,evolution:[],bureauMax:null,bureauMin:null});return m.useEffect(()=>{a()},[a]),m.useEffect(()=>{if(r.length===0)return;const x=r.reduce((j,C)=>j+(C.inscrits||0),0),p=r.reduce((j,C)=>j+(C.votants20h||0),0),v=x>0?p/x*100:0,S=["08h","09h","10h","11h","12h","13h","14h","15h","16h","17h","18h","19h","20h"].map(j=>{const C=r.reduce((I,b)=>{const T=`votants${j}`;return I+(b[T]||0)},0);return{heure:j,votants:C,taux:x>0?C/x*100:0}}),g=r.map(j=>{const C=s.find(I=>I.id===j.bureauId);return{bureauId:j.bureauId,bureauNom:(C==null?void 0:C.nom)||j.bureauId,inscrits:j.inscrits||0,votants:j.votants20h||0,taux:j.inscrits>0?(j.votants20h||0)/j.inscrits*100:0}}).filter(j=>j.inscrits>0),f=g.reduce((j,C)=>C.taux>((j==null?void 0:j.taux)||0)?C:j,null),N=g.reduce((j,C)=>C.taux<((j==null?void 0:j.taux)||100)?C:j,null);i({totalInscrits:x,totalVotants:p,tauxParticipation:v,evolution:S,bureauMax:f,bureauMin:N})},[r,s]),e.jsxs("div",{className:"participation-stats",children:[e.jsxs("h2",{children:["üìà Statistiques de participation - Tour ",l.tourActuel]}),e.jsxs("div",{className:"stats-grid",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:t.totalInscrits.toLocaleString("fr-FR")}),e.jsx("div",{className:"stat-label",children:"Inscrits"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:t.totalVotants.toLocaleString("fr-FR")}),e.jsx("div",{className:"stat-label",children:"Votants (20h)"})]}),e.jsxs("div",{className:"stat-card highlight",children:[e.jsxs("div",{className:"stat-value",children:[t.tauxParticipation.toFixed(2),"%"]}),e.jsx("div",{className:"stat-label",children:"Taux de participation"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:(t.totalInscrits-t.totalVotants).toLocaleString("fr-FR")}),e.jsx("div",{className:"stat-label",children:"Abstentions"})]})]}),e.jsxs("div",{className:"evolution-section",children:[e.jsx("h3",{children:"√âvolution horaire"}),e.jsx("div",{className:"evolution-chart",children:t.evolution.map((x,p)=>e.jsxs("div",{className:"chart-bar",children:[e.jsx("div",{className:"bar",style:{height:`${x.taux}%`,backgroundColor:`hsl(${120-x.taux}, 70%, 50%)`},children:e.jsxs("span",{className:"bar-value",children:[x.taux.toFixed(1),"%"]})}),e.jsx("div",{className:"bar-label",children:x.heure}),e.jsx("div",{className:"bar-votants",children:x.votants.toLocaleString("fr-FR")})]},x.heure))})]}),e.jsxs("div",{className:"extremes-section",children:[e.jsx("h3",{children:"üéØ Bureaux extr√™mes"}),e.jsxs("div",{className:"extremes-table",role:"table","aria-label":"Participation maximale et minimale",children:[e.jsxs("div",{className:"extremes-row max",role:"row",children:[e.jsxs("div",{className:"extremes-type",role:"cell",children:["üèÜ ",e.jsx("span",{children:"Max"})]}),e.jsxs("div",{className:"extremes-bureau",role:"cell",children:[e.jsx("div",{className:"bureau-name",children:((u=t.bureauMax)==null?void 0:u.bureauNom)||"‚Äî"}),e.jsx("div",{className:"bureau-details",children:t.bureauMax?`${t.bureauMax.votants.toLocaleString("fr-FR")} votants / ${t.bureauMax.inscrits.toLocaleString("fr-FR")} inscrits`:"Aucune donn√©e"})]}),e.jsxs("div",{className:"extremes-metric",role:"cell",children:[e.jsx("div",{className:"meter","aria-hidden":"true",children:e.jsx("div",{className:"meter-fill",style:{width:`${Math.min(100,Math.max(0,((n=t.bureauMax)==null?void 0:n.taux)||0))}%`}})}),e.jsxs("div",{className:"meter-value",children:[(((c=t.bureauMax)==null?void 0:c.taux)||0).toFixed(2),"%"]})]})]}),e.jsxs("div",{className:"extremes-row min",role:"row",children:[e.jsxs("div",{className:"extremes-type",role:"cell",children:["üìâ ",e.jsx("span",{children:"Min"})]}),e.jsxs("div",{className:"extremes-bureau",role:"cell",children:[e.jsx("div",{className:"bureau-name",children:((d=t.bureauMin)==null?void 0:d.bureauNom)||"‚Äî"}),e.jsx("div",{className:"bureau-details",children:t.bureauMin?`${t.bureauMin.votants.toLocaleString("fr-FR")} votants / ${t.bureauMin.inscrits.toLocaleString("fr-FR")} inscrits`:"Aucune donn√©e"})]}),e.jsxs("div",{className:"extremes-metric",role:"cell",children:[e.jsx("div",{className:"meter","aria-hidden":"true",children:e.jsx("div",{className:"meter-fill",style:{width:`${Math.min(100,Math.max(0,((h=t.bureauMin)==null?void 0:h.taux)||0))}%`}})}),e.jsxs("div",{className:"meter-value",children:[(((o=t.bureauMin)==null?void 0:o.taux)||0).toFixed(2),"%"]})]})]})]})]}),e.jsxs("div",{className:"analysis-section",children:[e.jsx("h3",{children:"üìä Analyse"}),(()=>{const x=t.evolution.length>0?t.tauxParticipation/t.evolution.length:0,p=t.bureauMax&&t.bureauMin?t.bureauMax.taux-t.bureauMin.taux:0,v=r.length,E=s.length;return e.jsxs("div",{className:"analysis-diagrams",children:[e.jsxs("div",{className:"metric-card",children:[e.jsxs("div",{className:"metric-head",children:[e.jsx("span",{className:"metric-emoji",children:"üìà"}),e.jsx("span",{className:"metric-title",children:"Progression moyenne"})]}),e.jsxs("div",{className:"metric-value",children:["Progression moyenne par heure : ",x.toFixed(2),"% / heure"]}),e.jsx("div",{className:"meter",children:e.jsx("div",{className:"meter-fill",style:{width:`${Math.min(100,Math.max(0,x))}%`}})})]}),e.jsxs("div",{className:"metric-card",children:[e.jsxs("div",{className:"metric-head",children:[e.jsx("span",{className:"metric-emoji",children:"üìä"}),e.jsx("span",{className:"metric-title",children:"√âcart max / min"})]}),e.jsxs("div",{className:"metric-value",children:["√âcart max/min : ",p.toFixed(2),"%"]}),e.jsx("div",{className:"meter",children:e.jsx("div",{className:"meter-fill",style:{width:`${Math.min(100,Math.max(0,p))}%`}})})]}),e.jsxs("div",{className:"metric-card",children:[e.jsxs("div",{className:"metric-head",children:[e.jsx("span",{className:"metric-emoji",children:"üó≥Ô∏è"}),e.jsx("span",{className:"metric-title",children:"Bureaux d√©clar√©s"})]}),e.jsxs("div",{className:"metric-value",children:["Bureaux d√©clar√©s : ",v," / ",E]}),e.jsx("div",{className:"meter",children:e.jsx("div",{className:"meter-fill",style:{width:`${E>0?Math.min(100,Math.max(0,v/E*100)):0}%`}})})]})]})})()]})]})};function ue(l){const s={},r=(l.blancs||0)+(l.nuls||0)+(l.exprimes||0);if(l.votants!==r&&(s.votants=`Votants (${l.votants}) doit √™tre √©gal √† Blancs + Nuls + Exprim√©s (${r})`),l.voix){let a=0;for(const t of Object.values(l.voix))a+=parseInt(t)||0;a!==l.exprimes&&(s.exprimes=`Somme des voix (${a}) doit √™tre √©gale aux Exprim√©s (${l.exprimes})`)}return{valid:Object.keys(s).length===0,errors:s}}const he=ue,xe=()=>{const{state:l}=R(),{data:s,load:r}=y("Bureaux"),{data:a,load:t}=y("Candidats"),{data:i,load:u,create:n,update:c}=y(l.tourActuel===1?"Resultats_T1":"Resultats_T2"),[d,h]=m.useState(""),[o,x]=m.useState({votants:0,blancs:0,nuls:0,exprimes:0,voix:{}}),[p,v]=m.useState({}),[E,S]=m.useState(!1),[g,f]=m.useState(null);m.useEffect(()=>{r(),t(),u()},[r,t,u]),m.useEffect(()=>{const b={};if(a.forEach(T=>{b[T.id]=0}),d){const T=i.find(A=>A.bureauId===d);x(T?{votants:T.votants||0,blancs:T.blancs||0,nuls:T.nuls||0,exprimes:T.exprimes||0,voix:T.voix||b}:{votants:0,blancs:0,nuls:0,exprimes:0,voix:b})}},[d,a,i]),m.useEffect(()=>{const b=Object.values(o.voix).reduce((T,A)=>T+(parseInt(A)||0),0);b!==o.exprimes&&x(T=>({...T,exprimes:b}))},[o.voix]);const N=(b,T)=>{const A=parseInt(T)||0;x(V=>({...V,[b]:A})),v({}),f(null)},j=(b,T)=>{const A=parseInt(T)||0;x(V=>({...V,voix:{...V.voix,[b]:A}})),v({}),f(null)},C=async b=>{if(b.preventDefault(),!d){f({type:"error",text:"Veuillez selectionner un bureau"});return}const T=he(o);if(!T.valid){v(T.errors),f({type:"error",text:"Veuillez corriger les erreurs avant d'enregistrer"});return}try{S(!0),f(null);const A={bureauId:d,tour:l.tourActuel,votants:o.votants,blancs:o.blancs,nuls:o.nuls,exprimes:o.exprimes,voix:o.voix,timestamp:new Date().toISOString()},V=i.find(K=>K.bureauId===d);V?(await c(V.rowIndex,A),await L.log("UPDATE_RESULTATS",{bureau:d,tour:l.tourActuel})):(await n(A),await L.log("CREATE_RESULTATS",{bureau:d,tour:l.tourActuel})),f({type:"success",text:"Resultats enregistres avec succes"}),await u()}catch(A){console.error("Erreur enregistrement:",A),f({type:"error",text:`Erreur : ${A.message}`})}finally{S(!1)}},I=s.find(b=>b.id===d);return e.jsxs("div",{className:"resultats-saisie",children:[e.jsxs("h2",{children:["Saisie des resultats - Tour ",l.tourActuel]}),e.jsxs("form",{onSubmit:C,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Bureau de vote :"}),e.jsxs("select",{value:d,onChange:b=>h(b.target.value),required:!0,children:[e.jsx("option",{value:"",children:"-- Selectionner un bureau --"},"__placeholder"),s.map((b,T)=>e.jsx("option",{value:b.id,children:b.nom},b.id??`bureau-${T}`))]})]}),d&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bureau-info",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Bureau :"})," ",I==null?void 0:I.nom]}),e.jsxs("p",{children:[e.jsx("strong",{children:"President :"})," ",I==null?void 0:I.president]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Secretaire :"})," ",I==null?void 0:I.secretaire]})]}),e.jsxs("div",{className:"resultats-grid",children:[e.jsx("h3",{children:"Decompte des bulletins :"}),e.jsxs("div",{className:"form-row",children:[e.jsx("label",{children:"Votants :"}),e.jsx("input",{type:"number",min:"0",value:o.votants,onChange:b=>N("votants",b.target.value),required:!0}),p.votants&&e.jsx("span",{className:"error",children:p.votants})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("label",{children:"Bulletins blancs :"}),e.jsx("input",{type:"number",min:"0",value:o.blancs,onChange:b=>N("blancs",b.target.value),required:!0})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("label",{children:"Bulletins nuls :"}),e.jsx("input",{type:"number",min:"0",value:o.nuls,onChange:b=>N("nuls",b.target.value),required:!0})]}),e.jsxs("div",{className:"form-row highlight",children:[e.jsx("label",{children:"Suffrages exprimes :"}),e.jsx("input",{type:"number",value:o.exprimes,disabled:!0,className:"calculated"}),e.jsx("span",{className:"info",children:"Calcule automatiquement"}),p.exprimes&&e.jsx("span",{className:"error",children:p.exprimes})]}),e.jsx("div",{className:"control-panel",children:e.jsxs("div",{className:`control-check ${o.votants===o.blancs+o.nuls+o.exprimes?"valid":"invalid"}`,children:[e.jsx("strong",{children:"Controle :"})," Votants = Blancs + Nuls + Exprimes",e.jsx("br",{}),o.votants," = ",o.blancs," + ",o.nuls," + ",o.exprimes,o.votants===o.blancs+o.nuls+o.exprimes?" OK":" ERREUR"]})})]}),e.jsxs("div",{className:"voix-grid",children:[e.jsx("h3",{children:"Voix par candidat :"}),a.map((b,T)=>e.jsxs("div",{className:"candidat-row",children:[e.jsxs("label",{children:[b.nom," :"]}),e.jsx("input",{type:"number",min:"0",value:o.voix[b.id]||0,onChange:A=>j(b.id,A.target.value),required:!0})]},b.id??`candidat-${T}`)),e.jsx("div",{className:"control-panel",children:e.jsxs("div",{className:`control-check ${o.exprimes===Object.values(o.voix).reduce((b,T)=>b+(parseInt(T)||0),0)?"valid":"invalid"}`,children:[e.jsx("strong",{children:"Controle :"})," Somme des voix = Exprimes",e.jsx("br",{}),Object.values(o.voix).reduce((b,T)=>b+(parseInt(T)||0),0)," = ",o.exprimes,o.exprimes===Object.values(o.voix).reduce((b,T)=>b+(parseInt(T)||0),0)?" OK":" ERREUR"]})})]}),g&&e.jsx("div",{className:`message ${g.type}`,children:g.text}),e.jsx("div",{className:"form-actions",children:e.jsx("button",{type:"submit",className:"btn-primary",disabled:E||Object.keys(p).length>0,children:E?"Enregistrement...":"Enregistrer les resultats"})})]})]})]})},me=()=>{const{state:l}=R(),{data:s}=y("Bureaux"),{data:r}=y("Candidats"),{data:a,load:t}=y(l.tourActuel===1?"R√©sultats_T1":"R√©sultats_T2"),[i,u]=m.useState({totaux:{votants:0,blancs:0,nuls:0,exprimes:0},candidats:[],tauxParticipation:0,totalInscrits:0});return m.useEffect(()=>{t()},[t]),m.useEffect(()=>{if(a.length===0)return;const n=a.reduce((o,x)=>({votants:o.votants+(x.votants||0),blancs:o.blancs+(x.blancs||0),nuls:o.nuls+(x.nuls||0),exprimes:o.exprimes+(x.exprimes||0)}),{votants:0,blancs:0,nuls:0,exprimes:0}),c=r.map(o=>{const x=a.reduce((v,E)=>{var S;return v+(((S=E.voix)==null?void 0:S[o.id])||0)},0),p=n.exprimes>0?x/n.exprimes*100:0;return{...o,voix:x,pourcentage:p}});c.sort((o,x)=>x.voix-o.voix);const d=s.reduce((o,x)=>o+(x.inscrits||0),0),h=d>0?n.votants/d*100:0;u({totaux:n,candidats:c,tauxParticipation:h,totalInscrits:d})},[a,r,s]),e.jsxs("div",{className:"resultats-consolidation",children:[e.jsxs("h2",{children:["üìä Consolidation communale - Tour ",l.tourActuel]}),e.jsxs("div",{className:"totaux-grid",children:[e.jsxs("div",{className:"total-card",children:[e.jsx("div",{className:"card-value",children:i.totalInscrits.toLocaleString("fr-FR")}),e.jsx("div",{className:"card-label",children:"Inscrits"})]}),e.jsxs("div",{className:"total-card",children:[e.jsx("div",{className:"card-value",children:i.totaux.votants.toLocaleString("fr-FR")}),e.jsx("div",{className:"card-label",children:"Votants"})]}),e.jsxs("div",{className:"total-card highlight",children:[e.jsxs("div",{className:"card-value",children:[i.tauxParticipation.toFixed(2),"%"]}),e.jsx("div",{className:"card-label",children:"Participation"})]}),e.jsxs("div",{className:"total-card",children:[e.jsx("div",{className:"card-value",children:i.totaux.blancs.toLocaleString("fr-FR")}),e.jsx("div",{className:"card-label",children:"Blancs"})]}),e.jsxs("div",{className:"total-card",children:[e.jsx("div",{className:"card-value",children:i.totaux.nuls.toLocaleString("fr-FR")}),e.jsx("div",{className:"card-label",children:"Nuls"})]}),e.jsxs("div",{className:"total-card",children:[e.jsx("div",{className:"card-value",children:i.totaux.exprimes.toLocaleString("fr-FR")}),e.jsx("div",{className:"card-label",children:"Exprim√©s"})]})]}),e.jsxs("div",{className:"resultats-candidats",children:[e.jsx("h3",{children:"R√©sultats par candidat :"}),e.jsxs("table",{className:"candidats-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Rang"}),e.jsx("th",{children:"Candidat"}),e.jsx("th",{children:"Voix"}),e.jsx("th",{children:"% Exprim√©s"}),e.jsx("th",{children:"% Inscrits"}),e.jsx("th",{children:"Barre visuelle"})]})}),e.jsx("tbody",{children:i.candidats.map((n,c)=>e.jsxs("tr",{className:c<2?"qualified":"",children:[e.jsx("td",{className:"rank",children:e.jsx("span",{className:`rank-badge rank-${c+1}`,children:c+1})}),e.jsx("td",{className:"candidat-name",children:e.jsx("strong",{children:n.nom})}),e.jsx("td",{className:"voix",children:n.voix.toLocaleString("fr-FR")}),e.jsxs("td",{className:"percentage",children:[n.pourcentage.toFixed(2),"%"]}),e.jsxs("td",{className:"percentage-inscrits",children:[i.totalInscrits>0?(n.voix/i.totalInscrits*100).toFixed(2):0,"%"]}),e.jsx("td",{className:"progress-bar",children:e.jsx("div",{className:"bar-container",children:e.jsx("div",{className:"bar-fill",style:{width:`${n.pourcentage}%`,backgroundColor:c===0?"#4CAF50":c===1?"#2196F3":"#9E9E9E"},children:n.pourcentage>10&&e.jsxs("span",{className:"bar-text",children:[n.pourcentage.toFixed(1),"%"]})})})})]},n.id))})]}),i.candidats.length>=2&&e.jsx("div",{className:"qualified-notice",children:e.jsx("strong",{children:"Les 2 premiers candidats sont qualifi√©s pour le 2nd tour"})})]}),e.jsxs("div",{className:"stats-complementaires",children:[e.jsx("h3",{children:"Statistiques :"}),e.jsxs("div",{className:"stats-row",children:[e.jsx("span",{children:"Bureaux d√©clar√©s :"}),e.jsx("span",{children:e.jsxs("strong",{children:[a.length," / ",s.length]})})]}),e.jsxs("div",{className:"stats-row",children:[e.jsx("span",{children:"Taux de blancs :"}),e.jsxs("span",{children:[i.totaux.votants>0?(i.totaux.blancs/i.totaux.votants*100).toFixed(2):0,"%"]})]}),e.jsxs("div",{className:"stats-row",children:[e.jsx("span",{children:"Taux de nuls :"}),e.jsxs("span",{children:[i.totaux.votants>0?(i.totaux.nuls/i.totaux.votants*100).toFixed(2):0,"%"]})]}),e.jsxs("div",{className:"stats-row",children:[e.jsx("span",{children:"√âcart 1er/2√®me :"}),e.jsx("span",{children:i.candidats.length>=2?(i.candidats[0].voix-i.candidats[1].voix).toLocaleString("fr-FR")+" voix":"N/A"})]})]})]})},pe=({onValidate:l})=>{const{state:s}=R(),{data:r}=y("Bureaux"),{data:a,load:t}=y(s.tourActuel===1?"R√©sultats_T1":"R√©sultats_T2"),[i,u]=m.useState({bureaux:[],erreurs:[],avertissements:[],isValid:!1});m.useEffect(()=>{t()},[t]),m.useEffect(()=>{n()},[a,r]);const n=()=>{const d=[],h=[],o=[];r.forEach(x=>{const p=a.find(E=>E.bureauId===x.id),v={bureauId:x.id,bureauNom:x.nom,isDeclare:!!p,erreurs:[],avertissements:[]};if(!p)v.erreurs.push("R√©sultats non d√©clar√©s"),h.push(`${x.nom}: R√©sultats manquants`);else{const E=(p.blancs||0)+(p.nuls||0)+(p.exprimes||0);p.votants!==E&&(v.erreurs.push(`Votants (${p.votants}) ‚â† Blancs + Nuls + Exprim√©s (${E})`),h.push(`${x.nom}: Incoh√©rence votants`));const S=Object.values(p.voix||{}).reduce((g,f)=>g+(f||0),0);if(S!==p.exprimes&&(v.erreurs.push(`Somme voix (${S}) ‚â† Exprim√©s (${p.exprimes})`),h.push(`${x.nom}: Incoh√©rence exprim√©s`)),p.votants>0){const g=p.blancs/p.votants*100;g>10&&(v.avertissements.push(`Taux de blancs √©lev√©: ${g.toFixed(1)}%`),o.push(`${x.nom}: ${g.toFixed(1)}% de blancs`))}}d.push(v)}),u({bureaux:d,erreurs:h,avertissements:o,isValid:h.length===0&&d.every(x=>x.isDeclare)})},c=()=>{i.isValid&&l&&l()};return e.jsxs("div",{className:"resultats-validation",children:[e.jsxs("h2",{children:["‚úÖ Validation des r√©sultats - Tour ",s.tourActuel]}),e.jsx("div",{className:`validation-status ${i.isValid?"valid":"invalid"}`,children:i.isValid?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"status-icon",children:"‚úÖ"}),e.jsxs("div",{className:"status-text",children:[e.jsx("strong",{children:"Tous les r√©sultats sont valides"}),e.jsx("p",{children:"Tous les bureaux ont d√©clar√© leurs r√©sultats sans erreur"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"status-icon",children:"‚ö†Ô∏è"}),e.jsxs("div",{className:"status-text",children:[e.jsx("strong",{children:"Validation incompl√®te"}),e.jsxs("p",{children:[i.erreurs.length," erreur(s) √† corriger"]})]})]})}),i.erreurs.length>0&&e.jsxs("div",{className:"erreurs-section",children:[e.jsxs("h3",{children:["‚ùå Erreurs bloquantes (",i.erreurs.length,")"]}),e.jsx("ul",{className:"erreurs-list",children:i.erreurs.map((d,h)=>e.jsx("li",{className:"erreur-item",children:d},h))})]}),i.avertissements.length>0&&e.jsxs("div",{className:"avertissements-section",children:[e.jsxs("h3",{children:["‚ö†Ô∏è Avertissements (",i.avertissements.length,")"]}),e.jsx("ul",{className:"avertissements-list",children:i.avertissements.map((d,h)=>e.jsx("li",{className:"avertissement-item",children:d},h))})]}),e.jsxs("div",{className:"bureaux-detail",children:[e.jsx("h3",{children:"D√©tail par bureau :"}),e.jsxs("table",{className:"validation-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Bureau"}),e.jsx("th",{children:"Statut"}),e.jsx("th",{children:"Erreurs"}),e.jsx("th",{children:"Avertissements"})]})}),e.jsx("tbody",{children:i.bureaux.map(d=>e.jsxs("tr",{className:d.erreurs.length>0?"error":d.isDeclare?"success":"warning",children:[e.jsx("td",{children:d.bureauNom}),e.jsx("td",{children:d.isDeclare?d.erreurs.length>0?"‚ö†Ô∏è Erreurs":"‚úÖ Valide":"‚ùå Non d√©clar√©"}),e.jsx("td",{children:d.erreurs.length>0&&e.jsx("ul",{className:"mini-list",children:d.erreurs.map((h,o)=>e.jsx("li",{children:h},o))})}),e.jsx("td",{children:d.avertissements.length>0&&e.jsx("ul",{className:"mini-list",children:d.avertissements.map((h,o)=>e.jsx("li",{children:h},o))})})]},d.bureauId))})]})]}),l&&e.jsxs("div",{className:"validation-actions",children:[e.jsx("button",{onClick:c,disabled:!i.isValid,className:"btn-validate",children:i.isValid?"‚úÖ Verrouiller le tour":"‚ùå Impossible de verrouiller"}),!i.isValid&&e.jsx("p",{className:"validation-help",children:"Corrigez toutes les erreurs avant de verrouiller le tour"})]})]})},je=()=>{const{state:l}=R(),{data:s}=y("Candidats"),{data:r}=y(l.tourActuel===1?"R√©sultats_T1":"R√©sultats_T2"),[a,t]=m.useState([]),[i,u]=m.useState({exprimes:0,inscrits:0});return m.useEffect(()=>{if(r.length===0||s.length===0)return;const n=r.reduce((d,h)=>d+(h.exprimes||0),0),c=s.map(d=>{const h=r.reduce((o,x)=>{var p;return o+(((p=x.voix)==null?void 0:p[d.id])||0)},0);return{...d,voix:h,pourcentage:n>0?h/n*100:0}});c.sort((d,h)=>h.voix-d.voix),t(c),u({exprimes:n,inscrits:0})},[r,s]),e.jsxs("div",{className:"resultats-classement",children:[e.jsxs("h2",{children:["üèÜ Classement officiel - Tour ",l.tourActuel]}),e.jsx("div",{className:"classement-list",children:a.map((n,c)=>e.jsxs("div",{className:`classement-card rank-${c+1} ${c<2?"qualified":""}`,children:[e.jsx("div",{className:"rank-number",children:e.jsx("span",{className:"rank-badge",children:c+1})}),e.jsxs("div",{className:"candidat-info",children:[e.jsx("h3",{children:n.nom}),n.parti&&e.jsx("p",{className:"parti",children:n.parti})]}),e.jsxs("div",{className:"voix-info",children:[e.jsxs("div",{className:"voix-number",children:[n.voix.toLocaleString("fr-FR")," voix"]}),e.jsxs("div",{className:"pourcentage",children:[n.pourcentage.toFixed(2),"% des exprim√©s"]})]}),e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${n.pourcentage}%`,backgroundColor:c===0?"#4CAF50":c===1?"#2196F3":"#9E9E9E"}})}),c<2&&l.tourActuel===1&&e.jsx("div",{className:"qualified-badge",children:"‚úÖ Qualifi√© pour le 2nd tour"})]},n.id))}),e.jsx("div",{className:"classement-footer",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Total des suffrages exprim√©s :"})," ",i.exprimes.toLocaleString("fr-FR")]})})]})},ve=()=>{const{passerSecondTour:l}=R(),{data:s}=y("Candidats"),{data:r}=y("R√©sultats_T1"),[a,t]=m.useState([]),[i,u]=m.useState([]),[n,c]=m.useState(!1),[d,h]=m.useState(!1),[o,x]=m.useState(null);m.useEffect(()=>{if(r.length===0||s.length===0)return;const v=r.reduce((S,g)=>S+(g.exprimes||0),0),E=s.map(S=>{const g=r.reduce((f,N)=>{var j;return f+(((j=N.voix)==null?void 0:j[S.id])||0)},0);return{...S,voix:g,pourcentage:v>0?g/v*100:0}});if(E.sort((S,g)=>g.voix-S.voix),t(E),E.length>=2){const S=E[0],g=E[1];S.voix===g.voix?(c(!0),x({type:"warning",text:"‚ö†Ô∏è √âgalit√© parfaite entre les 2 premiers candidats. D√©cision admin requise."})):(c(!1),u([S,g]))}},[r,s]);const p=async()=>{if(i.length!==2){x({type:"error",text:"Vous devez s√©lectionner exactement 2 candidats"});return}if(window.confirm(`Confirmer le passage au 2nd tour avec:
1. ${i[0].nom}
2. ${i[1].nom}`))try{h(!0),await l(i),await L.log("PASSAGE_SECOND_TOUR",{candidats:i.map(v=>({id:v.id,nom:v.nom,voix:v.voix}))}),x({type:"success",text:"‚úÖ Passage au 2nd tour effectu√© avec succ√®s"})}catch(v){x({type:"error",text:`Erreur: ${v.message}`})}finally{h(!1)}};return e.jsxs("div",{className:"passage-t2",children:[e.jsx("h2",{children:"‚û°Ô∏è Passage au 2nd tour"}),e.jsxs("div",{className:"classement-t1",children:[e.jsx("h3",{children:"Classement 1er tour :"}),e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Rang"}),e.jsx("th",{children:"Candidat"}),e.jsx("th",{children:"Voix"}),e.jsx("th",{children:"%"}),e.jsx("th",{children:"Qualifi√©"})]})}),e.jsx("tbody",{children:a.map((v,E)=>e.jsxs("tr",{className:E<2?"qualified":"",children:[e.jsx("td",{children:E+1}),e.jsx("td",{children:e.jsx("strong",{children:v.nom})}),e.jsx("td",{children:v.voix.toLocaleString("fr-FR")}),e.jsxs("td",{children:[v.pourcentage.toFixed(2),"%"]}),e.jsx("td",{children:E<2?"‚úÖ":"‚ùå"})]},v.id))})]})]}),o&&e.jsx("div",{className:`message ${o.type}`,children:o.text}),!n&&i.length===2&&e.jsxs("div",{className:"qualification-panel",children:[e.jsx("h3",{children:"Candidats qualifi√©s pour le 2nd tour :"}),e.jsxs("div",{className:"qualifies-list",children:[e.jsxs("div",{className:"qualifie-card",children:[e.jsx("div",{className:"rank",children:"1er"}),e.jsx("div",{className:"nom",children:i[0].nom}),e.jsxs("div",{className:"voix",children:[i[0].voix.toLocaleString("fr-FR")," voix"]})]}),e.jsxs("div",{className:"qualifie-card",children:[e.jsx("div",{className:"rank",children:"2√®me"}),e.jsx("div",{className:"nom",children:i[1].nom}),e.jsxs("div",{className:"voix",children:[i[1].voix.toLocaleString("fr-FR")," voix"]})]})]})]}),e.jsx("div",{className:"actions",children:e.jsx("button",{onClick:p,disabled:d||n||i.length!==2,className:"btn-primary",children:d?"Traitement...":"‚û°Ô∏è Confirmer passage au 2nd tour"})})]})},ge=()=>{const{state:l}=R();return e.jsxs("div",{className:"config-t2",children:[e.jsx("h2",{children:"‚öôÔ∏è Configuration 2nd tour"}),l.candidatsQualifies&&l.candidatsQualifies.length===2?e.jsxs("div",{className:"config-info",children:[e.jsx("h3",{children:"Candidats qualifi√©s :"}),e.jsx("ul",{children:l.candidatsQualifies.map((s,r)=>e.jsxs("li",{children:[e.jsxs("strong",{children:[r+1,"."]})," ",s.nom," (",s.voix," voix au T1)"]},s.id))}),e.jsxs("div",{className:"date-info",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Date du 2nd tour :"})," ",new Date(l.dateT2).toLocaleDateString("fr-FR")]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Horaires :"})," 08h00 - 20h00"]})]})]}):e.jsx("p",{className:"warning",children:"Le passage au 2nd tour n'a pas encore √©t√© effectu√©."})]})};function fe(l){if(!l||l.length<2)throw new Error("Au moins 2 listes requises pour d√©terminer les qualifi√©s");const s=[...l].sort((a,t)=>t.voix-a.voix),r=s[0].voix===s[1].voix;return{qualified:[s[0].listeId,s[1].listeId],egalite:r,classement:s}}function be(l,s=35,r=5){const a=l.reduce((o,x)=>o+x.voix,0);if(a===0)throw new Error("Aucun suffrage exprim√©");const t=a*r/100,i=l.map(o=>({...o,pctVoix:o.voix/a*100,eligible:o.voix>=t})).filter(o=>o.eligible).sort((o,x)=>x.voix-o.voix);if(i.length===0)throw new Error("Aucune liste √©ligible (seuil non atteint)");const u=Math.floor(s/2),n=s-u,c=i[0],d=i.map(o=>{if(o.listeId===c.listeId){const x=G([o],i,n)[0];return{listeId:o.listeId,nomListe:o.nomListe,voix:o.voix,pctVoix:o.pctVoix,siegesMajoritaire:u,siegesProportionnels:x,siegesTotal:u+x,eligible:!0}}else{const x=G([o],i,n)[0];return{listeId:o.listeId,nomListe:o.nomListe,voix:o.voix,pctVoix:o.pctVoix,siegesMajoritaire:0,siegesProportionnels:x,siegesTotal:x,eligible:!0}}}),h=d.reduce((o,x)=>o+x.siegesTotal,0);return h!==s&&console.warn(`Ajustement n√©cessaire: ${h} si√®ges attribu√©s au lieu de ${s}`),d}function G(l,s,r){const a=s.map(t=>({listeId:t.listeId,voix:t.voix,sieges:0}));for(let t=0;t<r;t++){const i=a.map(d=>({listeId:d.listeId,quotient:d.voix/(d.sieges+1)})),u=Math.max(...i.map(d=>d.quotient)),n=i.find(d=>d.quotient===u),c=a.findIndex(d=>d.listeId===n.listeId);a[c].sieges++}return l.map(t=>{const i=a.find(u=>u.listeId===t.listeId);return i?i.sieges:0})}function Ne(l,s=6,r=5){const a=l.reduce((n,c)=>n+c.voix,0);if(a===0)throw new Error("Aucun suffrage exprim√©");const t=a*r/100,i=l.map(n=>({...n,pctMunicipal:n.voix/a*100,eligible:n.voix>=t})).filter(n=>n.eligible).sort((n,c)=>c.voix-n.voix);if(i.length===0)throw new Error("Aucune liste √©ligible (seuil non atteint)");const u=Ee(i,s);return i.map((n,c)=>({listeId:n.listeId,nomListe:n.nomListe,voixMunicipal:n.voix,pctMunicipal:n.pctMunicipal,siegesCommunautaires:u[c],eligible:!0}))}function Ee(l,s){const r=l.map(a=>({listeId:a.listeId,voix:a.voix,sieges:0}));for(let a=0;a<s;a++){const t=r.map(c=>({listeId:c.listeId,quotient:c.voix/(c.sieges+1)})),i=Math.max(...t.map(c=>c.quotient)),u=t.find(c=>c.quotient===i),n=r.findIndex(c=>c.listeId===u.listeId);r[n].sieges++}return r.map(a=>a.sieges)}function Se(l,s){const r=l.reduce((c,d)=>c+d.voix,0);if(r===0)return!0;const a=l.reduce((c,d)=>d.voix>c.voix?d:c,l[0]),t=a.voix/r*100,i=a.voix/s*100,u=t>50,n=i>25;return!(u&&n)}function Te(l,s,r,a){const t=l.reduce((u,n)=>u+n.voix,0),i=t*a/100;return{totalExprimes:t,seuilPct:a,seuilVoix:i,totalSieges:r,siegesMajoritaire:Math.floor(r/2),siegesProportionnels:r-Math.floor(r/2),details:s,sommeSiegesAttribues:s.reduce((u,n)=>u+n.siegesTotal,0)}}class we{async consoliderResultats(s=1){try{const r=await w.getResultats(s),t=(await w.getCandidats()).filter(p=>s===1?p.actifT1:p.actifT2);let i=0,u=0,n=0,c=0,d=0;const h={};t.forEach(p=>{h[p.listeId]=0});const o=r.filter(p=>p.bureauId!=="TOTAL");o.forEach(p=>{i+=p.inscrits,u+=p.votants,n+=p.blancs,c+=p.nuls,d+=p.exprimes;for(const v in h)h[v]+=p.voix[v]||0});const x=t.map(p=>({listeId:p.listeId,nomListe:p.nomListe,teteListeNom:p.teteListeNom,teteListePrenom:p.teteListePrenom,couleur:p.couleur,voix:h[p.listeId],pctExprimes:d>0?h[p.listeId]/d*100:0,pctInscrits:i>0?h[p.listeId]/i*100:0})).sort((p,v)=>v.voix-p.voix);return{tour:s,totalInscrits:i,totalVotants:u,totalBlancs:n,totalNuls:c,totalExprimes:d,tauxParticipation:i>0?u/i*100:0,resultatsParListe:x,nombreBureaux:o.length}}catch(r){throw console.error("Erreur consolidation r√©sultats:",r),r}}async determinerSecondTour(){try{const s=await this.consoliderResultats(1),r=await w.getConfig();if(!Se(s.resultatsParListe,s.totalInscrits))return{necessaire:!1,raison:"Majorit√© absolue obtenue au 1er tour",listeMajoritaire:s.resultatsParListe[0]};const{qualified:t,egalite:i,classement:u}=fe(s.resultatsParListe);return{necessaire:!0,qualified:t,egalite:i,classement:u,liste1:s.resultatsParListe.find(n=>n.listeId===t[0]),liste2:s.resultatsParListe.find(n=>n.listeId===t[1])}}catch(s){throw console.error("Erreur d√©termination second tour:",s),s}}async activerSecondTour(){try{const s=await this.determinerSecondTour();if(!s.necessaire)throw new Error("Second tour non n√©cessaire");if(s.egalite)throw new Error("√âgalit√© d√©tect√©e - D√©cision manuelle requise");return await w.activerListesT2(s.qualified[0],s.qualified[1]),await w.updateElectionState("T1_CLOSED","TRUE"),await w.updateElectionState("T2_QUALIFIED_LISTE1",s.qualified[0]),await w.updateElectionState("T2_QUALIFIED_LISTE2",s.qualified[1]),await w.updateElectionState("CURRENT_TOUR","2"),await w.updateConfig("CURRENT_TOUR",2),await L.log("CALCULATE","SecondTour","ALL",{},{qualified:s.qualified,liste1:s.liste1,liste2:s.liste2}),s}catch(s){throw console.error("Erreur activation second tour:",s),s}}async calculerSiegesMunicipal(s=null){try{s===null&&(s=(await w.getConfig()).CURRENT_TOUR||1);const r=await this.consoliderResultats(s),a=await w.getConfig(),t=be(r.resultatsParListe,a.SEATS_MUNICIPAL_TOTAL||35,a.SEATS_THRESHOLD_PCT||5);await w.saveSiegesMunicipal(t,s),await w.updateElectionState("SEATS_CALCULATED","TRUE");const i=Te(r.resultatsParListe,t,a.SEATS_MUNICIPAL_TOTAL||35,a.SEATS_THRESHOLD_PCT||5);return await L.log("CALCULATE","Seats_Municipal","ALL",{},i),{sieges:t,rapport:i,consolidation:r}}catch(r){throw console.error("Erreur calcul si√®ges municipaux:",r),r}}async calculerSiegesCommunautaire(s=null){try{s===null&&(s=(await w.getConfig()).CURRENT_TOUR||1);const r=await this.consoliderResultats(s),a=await w.getConfig(),t=Ne(r.resultatsParListe,a.SEATS_COMMUNITY_TOTAL||6,a.SEATS_THRESHOLD_PCT||5);return await w.saveSiegesCommunautaire(t),await L.log("CALCULATE","Seats_Community","ALL",{},{sieges:t}),{sieges:t,consolidation:r}}catch(r){throw console.error("Erreur calcul si√®ges communautaires:",r),r}}async calculerStatistiquesParticipation(s=1){try{const r=await w.getParticipation(s),a=await w.getBureaux(),t={};r.forEach(d=>{t[d.bureauId]||(t[d.bureauId]=[]),t[d.bureauId].push(d)});const i=a.map(d=>{const h=t[d.id]||[],o=h[h.length-1];return{bureauId:d.id,nom:d.nom,inscrits:d.inscrits,votants:(o==null?void 0:o.votants)||0,tauxPct:(o==null?void 0:o.tauxPct)||0,evolution:h.map(x=>({heure:x.heure,votants:x.votants,tauxPct:x.tauxPct}))}}),u=i.reduce((d,h)=>d+h.inscrits,0),n=i.reduce((d,h)=>d+h.votants,0),c=u>0?n/u*100:0;return{tour:s,totalInscrits:u,totalVotants:n,tauxGlobal:c,statsBureaux:i,derniereMiseAJour:new Date().toISOString()}}catch(r){throw console.error("Erreur calcul statistiques participation:",r),r}}async verifierCoherence(s=1){try{const r=await w.getResultats(s),a=[];return r.forEach(t=>{if(t.bureauId==="TOTAL")return;const i=t.blancs+t.nuls+t.exprimes;t.votants!==i&&a.push({bureauId:t.bureauId,type:"INCOHERENCE_VOTANTS",message:`Votants (${t.votants}) ‚â† Blancs + Nuls + Exprim√©s (${i})`});const u=Object.values(t.voix).reduce((n,c)=>n+c,0);u!==t.exprimes&&a.push({bureauId:t.bureauId,type:"INCOHERENCE_VOIX",message:`Somme des voix (${u}) ‚â† Exprim√©s (${t.exprimes})`}),t.votants>t.inscrits&&a.push({bureauId:t.bureauId,type:"VOTANTS_SUPERIEURS_INSCRITS",message:`Votants (${t.votants}) > Inscrits (${t.inscrits})`})}),{coherent:a.length===0,erreurs:a}}catch(r){throw console.error("Erreur v√©rification coh√©rence:",r),r}}}const Y=new we,Ce=()=>{const{state:l}=R(),{data:s}=y("Candidats"),{data:r}=y(l.tourActuel===1?"R√©sultats_T1":"R√©sultats_T2"),[a,t]=m.useState([]),[i,u]=m.useState(29);return m.useEffect(()=>{if(r.length===0||s.length===0)return;const n=Y.calculerSiegesMunicipaux(r,s,i);t(n)},[r,s,i]),e.jsxs("div",{className:"sieges-municipal",children:[e.jsx("h2",{children:"ü™ë R√©partition des si√®ges - Conseil Municipal"}),e.jsxs("div",{className:"total-sieges",children:[e.jsx("strong",{children:"Total si√®ges √† attribuer :"})," ",i]}),e.jsxs("table",{className:"sieges-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Candidat"}),e.jsx("th",{children:"Voix"}),e.jsx("th",{children:"%"}),e.jsx("th",{children:"Si√®ges"}),e.jsx("th",{children:"M√©thode"})]})}),e.jsx("tbody",{children:a.map(n=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:n.nom})}),e.jsx("td",{children:n.voix.toLocaleString("fr-FR")}),e.jsxs("td",{children:[n.pourcentage.toFixed(2),"%"]}),e.jsx("td",{className:"sieges-number",children:n.sieges}),e.jsx("td",{children:n.methode})]},n.candidatId))})]}),e.jsxs("div",{className:"explication",children:[e.jsx("h4",{children:"M√©thode de calcul :"}),e.jsx("p",{children:"‚Ä¢ 50% des si√®ges √† la liste en t√™te (prime majoritaire)"}),e.jsx("p",{children:"‚Ä¢ Reste √† la proportionnelle √† la plus forte moyenne"})]})]})},ye=()=>{const{state:l}=R(),{data:s}=y("Candidats"),{data:r}=y(l.tourActuel===1?"R√©sultats_T1":"R√©sultats_T2"),[a,t]=m.useState([]),[i,u]=m.useState(5);return m.useEffect(()=>{if(r.length===0||s.length===0)return;const n=Y.calculerSiegesCommunautaires(r,s,i);t(n)},[r,s,i]),e.jsxs("div",{className:"sieges-communautaire",children:[e.jsx("h2",{children:"ü™ë R√©partition des si√®ges - Conseil Communautaire (SQY)"}),e.jsxs("div",{className:"total-sieges",children:[e.jsx("strong",{children:"Total si√®ges √† attribuer :"})," ",i]}),e.jsxs("table",{className:"sieges-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Candidat"}),e.jsx("th",{children:"Voix"}),e.jsx("th",{children:"%"}),e.jsx("th",{children:"Si√®ges"})]})}),e.jsx("tbody",{children:a.map(n=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:n.nom})}),e.jsx("td",{children:n.voix.toLocaleString("fr-FR")}),e.jsxs("td",{children:[n.pourcentage.toFixed(2),"%"]}),e.jsx("td",{className:"sieges-number",children:n.sieges})]},n.candidatId))})]}),e.jsxs("div",{className:"explication",children:[e.jsx("h4",{children:"M√©thode de calcul :"}),e.jsx("p",{children:"Proportionnelle bas√©e sur les r√©sultats municipaux"}),e.jsx("p",{children:"R√®gle pr√©fectorale de Saint-Quentin-en-Yvelines"})]})]})},Ie=()=>{const{data:l,load:s,loading:r}=y("Bureaux");return m.useEffect(()=>{s()},[s]),e.jsxs("div",{className:"config-bureaux",children:[e.jsx("h3",{children:"üìç Configuration des bureaux de vote"}),r?e.jsx("p",{children:"Chargement..."}):e.jsxs("table",{className:"admin-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Nom"}),e.jsx("th",{children:"Adresse"}),e.jsx("th",{children:"Pr√©sident"}),e.jsx("th",{children:"Secr√©taire"}),e.jsx("th",{children:"Inscrits"})]})}),e.jsx("tbody",{children:l.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.id}),e.jsx("td",{children:e.jsx("strong",{children:a.nom})}),e.jsx("td",{children:a.adresse}),e.jsx("td",{children:a.president}),e.jsx("td",{children:a.secretaire}),e.jsx("td",{children:a.inscrits})]},a.id))})]})]})},Re=()=>{const{state:l}=R(),{data:s,load:r,loading:a}=y("Candidats");m.useEffect(()=>{r()},[r]);const t=(l==null?void 0:l.tourActuel)??1,i=u=>t===1?u.actifT1:t===2?u.actifT2:!1;return e.jsxs("div",{className:"config-candidats",children:[e.jsxs("h3",{children:["üë§ Configuration des candidats - Tour ",t]}),a?e.jsx("p",{children:"Chargement..."}):e.jsxs("table",{className:"admin-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Nom"}),e.jsx("th",{children:"Liste / Parti"}),e.jsx("th",{children:"Tour"})]})}),e.jsx("tbody",{children:s.filter(i).sort((u,n)=>u.ordre-n.ordre).map(u=>e.jsxs("tr",{children:[e.jsx("td",{children:u.listeId}),e.jsx("td",{children:e.jsxs("strong",{children:[u.teteListePrenom," ",u.teteListeNom]})}),e.jsx("td",{children:u.nomListe}),e.jsxs("td",{children:[t===1&&u.actifT1&&"Tour 1",t===2&&u.actifT2&&"Tour 2"]})]},u.listeId))})]})]})},Ae=()=>{const{data:l,load:s,loading:r}=y("AuditLog");return m.useEffect(()=>{s()},[s]),e.jsxs("div",{className:"audit-log",children:[e.jsx("h3",{children:"üìù Journal d'audit"}),r?e.jsx("p",{children:"Chargement..."}):e.jsx("div",{className:"audit-table-container",children:e.jsxs("table",{className:"audit-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date/Heure"}),e.jsx("th",{children:"Utilisateur"}),e.jsx("th",{children:"Action"}),e.jsx("th",{children:"D√©tails"})]})}),e.jsx("tbody",{children:l.slice().reverse().map((a,t)=>e.jsxs("tr",{children:[e.jsx("td",{children:new Date(a.timestamp).toLocaleString("fr-FR")}),e.jsx("td",{children:a.user}),e.jsx("td",{children:e.jsx("strong",{children:a.action})}),e.jsx("td",{className:"details",children:JSON.stringify(a.details)})]},t))})]})})]})};function _(l){return typeof l!="number"?"0":l.toLocaleString("fr-FR")}function M(l,s=2){return typeof l!="number"||isNaN(l)?"0,00 %":l.toFixed(s).replace(".",",")+" %"}function q(l){if(!l)return"";const s=new Date(l);return isNaN(s.getTime())?"":new Intl.DateTimeFormat("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(s)}function F(l,s){const a=new Date().toISOString().replace(/[:.]/g,"-").slice(0,-5);return`${l}_${a}.${s}`}class Le{exportToCSV(s,r){try{const a=this.arrayToCSV(s),t=new Blob(["\uFEFF"+a],{type:"text/csv;charset=utf-8;"});this.downloadBlob(t,r),L.logExport("CSV",r,{rows:s.length})}catch(a){throw console.error("Erreur export CSV:",a),a}}arrayToCSV(s){if(!s||s.length===0)return"";const r=Object.keys(s[0]),a=s.map(t=>r.map(i=>{const u=t[i];return typeof u=="string"&&(u.includes(",")||u.includes('"')||u.includes(`
`))?`"${u.replace(/"/g,'""')}"`:u}).join(","));return[r.join(","),...a].join(`
`)}async exportParticipationCSV(s,r=1){const a=s.map(i=>({Bureau:i.bureauId,Heure:i.heure,Inscrits:i.inscrits,Votants:i.votants,"Taux (%)":i.tauxPct.toFixed(2),"Saisi par":i.saisiPar,Timestamp:q(i.timestamp)})),t=F(`participation_tour${r}`,"csv");this.exportToCSV(a,t)}async exportResultatsCSV(s,r,a=1){const t=s.map(u=>{const n={Bureau:u.bureauId,Inscrits:u.inscrits,Votants:u.votants,Blancs:u.blancs,Nuls:u.nuls,Exprim√©s:u.exprimes};return r.forEach(c=>{n[c.nomListe]=u.voix[c.listeId]||0}),n["Saisi par"]=u.saisiPar,n["Valid√© par"]=u.validePar,n.Timestamp=q(u.timestamp),n}),i=F(`resultats_tour${a}`,"csv");this.exportToCSV(t,i)}async exportSiegesMunicipalCSV(s){const r=s.map(t=>({Liste:t.nomListe,Voix:t.voix,"% Voix":M(t.pctVoix),"Si√®ges Majorit√©":t.siegesMajoritaire||0,"Si√®ges Proportionnels":t.siegesProportionnels||0,"Total Si√®ges":t.siegesTotal,√âligible:t.eligible?"Oui":"Non"})),a=F("sieges_municipal","csv");this.exportToCSV(r,a)}async exportSiegesCommunautaireCSV(s){const r=s.map(t=>({Liste:t.nomListe,"Voix Municipal":t.voixMunicipal,"% Municipal":M(t.pctMunicipal),"Si√®ges Communautaires":t.siegesCommunautaires,√âligible:t.eligible?"Oui":"Non"})),a=F("sieges_communautaire","csv");this.exportToCSV(r,a)}generatePVHTML(s,r,a=1){const t=new Date,i=this.consolidateResults(s,r);return`
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proc√®s-Verbal - √âlections Municipales ${k.COMMUNE_NAME} - Tour ${a}</title>
  <style>
    body {
      font-family: 'Times New Roman', serif;
      margin: 40px;
      color: #000;
    }
    .header {
      text-align: center;
      margin-bottom: 40px;
      border-bottom: 2px solid #0055A4;
      padding-bottom: 20px;
    }
    h1 {
      color: #0055A4;
      margin: 0;
    }
    .info {
      margin: 20px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    th, td {
      border: 1px solid #333;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #0055A4;
      color: white;
    }
    .total {
      font-weight: bold;
      background-color: #f0f0f0;
    }
    .signature {
      margin-top: 60px;
      display: flex;
      justify-content: space-between;
    }
    .signature-block {
      width: 40%;
    }
    @media print {
      body { margin: 20px; }
      .no-print { display: none; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>R√âPUBLIQUE FRAN√áAISE</h1>
    <h2>Proc√®s-Verbal - √âlections Municipales</h2>
    <h3>${k.COMMUNE_NAME} (${k.COMMUNE_CODE})</h3>
    <h3>${a===1?"1er Tour":"2nd Tour"} - ${k[a===1?"ELECTION_DATE_T1":"ELECTION_DATE_T2"]}</h3>
  </div>

  <div class="info">
    <p><strong>Date d'√©dition:</strong> ${q(t.toISOString())}</p>
    <p><strong>Nombre de bureaux:</strong> ${s.length}</p>
  </div>

  <h3>R√©sultats de la Participation</h3>
  <table>
    <tr>
      <th>Inscrits</th>
      <th>Votants</th>
      <th>Taux de participation</th>
      <th>Blancs</th>
      <th>Nuls</th>
      <th>Exprim√©s</th>
    </tr>
    <tr class="total">
      <td>${_(i.totalInscrits)}</td>
      <td>${_(i.totalVotants)}</td>
      <td>${M(i.tauxParticipation)}</td>
      <td>${_(i.totalBlancs)}</td>
      <td>${_(i.totalNuls)}</td>
      <td>${_(i.totalExprimes)}</td>
    </tr>
  </table>

  <h3>R√©sultats par Liste</h3>
  <table>
    <tr>
      <th>Rang</th>
      <th>Liste</th>
      <th>Voix</th>
      <th>% Exprim√©s</th>
      <th>% Inscrits</th>
    </tr>
    ${i.resultatsParListe.map((u,n)=>`
    <tr>
      <td>${n+1}</td>
      <td>${u.nomListe}</td>
      <td>${_(u.voix)}</td>
      <td>${M(u.pctExprimes)}</td>
      <td>${M(u.pctInscrits)}</td>
    </tr>
    `).join("")}
  </table>

  <div class="signature">
    <div class="signature-block">
      <p>Le Pr√©sident,</p>
      <br><br><br>
      <p>Signature:</p>
    </div>
    <div class="signature-block">
      <p>Le Secr√©taire,</p>
      <br><br><br>
      <p>Signature:</p>
    </div>
  </div>

  <button class="no-print" onclick="window.print()">Imprimer</button>
</body>
</html>
    `}consolidateResults(s,r){let a=0,t=0,i=0,u=0,n=0;const c={};r.forEach(h=>{c[h.listeId]={...h,voix:0}}),s.forEach(h=>{if(h.bureauId!=="TOTAL"){a+=h.inscrits,t+=h.votants,i+=h.blancs,u+=h.nuls,n+=h.exprimes;for(const o in c)c[o].voix+=h.voix[o]||0}});const d=Object.values(c).map(h=>({listeId:h.listeId,nomListe:h.nomListe,voix:h.voix,pctExprimes:n>0?h.voix/n*100:0,pctInscrits:a>0?h.voix/a*100:0})).sort((h,o)=>o.voix-h.voix);return{totalInscrits:a,totalVotants:t,totalBlancs:i,totalNuls:u,totalExprimes:n,tauxParticipation:a>0?t/a*100:0,resultatsParListe:d}}async openPVForPrint(s,r,a=1){const t=this.generatePVHTML(s,r,a),i=window.open("","_blank");i.document.write(t),i.document.close(),L.logExport("PV_HTML",`tour${a}`,{bureaux:s.length})}downloadBlob(s,r){const a=URL.createObjectURL(s),t=document.createElement("a");t.href=a,t.download=r,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(a)}}const z=new Le,Pe=()=>{const{state:l}=R(),s=async r=>{try{await z.exportPDF(r,l.tourActuel),alert(`PDF ${r} g√©n√©r√© avec succ√®s`)}catch(a){alert(`Erreur: ${a.message}`)}};return e.jsxs("div",{className:"export-pdf",children:[e.jsx("h3",{children:"üìÑ Exports PDF"}),e.jsxs("div",{className:"export-buttons",children:[e.jsx("button",{onClick:()=>s("participation"),children:"üìã PV Participation"}),e.jsx("button",{onClick:()=>s("resultats"),children:"üó≥Ô∏è PV R√©sultats"}),e.jsx("button",{onClick:()=>s("statistiques"),children:"üìä Statistiques"}),e.jsx("button",{onClick:()=>s("sieges"),children:"ü™ë R√©partition si√®ges"})]})]})},Ve=()=>{const{state:l}=R(),s=async r=>{try{await z.exportExcel(r,l.tourActuel),alert(`Excel ${r} t√©l√©charg√© avec succ√®s`)}catch(a){alert(`Erreur: ${a.message}`)}};return e.jsxs("div",{className:"export-excel",children:[e.jsx("h3",{children:"üìä Exports Excel"}),e.jsxs("div",{className:"export-buttons",children:[e.jsx("button",{onClick:()=>s("participation"),children:"üìã Participation"}),e.jsx("button",{onClick:()=>s("resultats"),children:"üó≥Ô∏è R√©sultats"}),e.jsx("button",{onClick:()=>s("sieges"),children:"ü™ë Si√®ges"}),e.jsx("button",{onClick:()=>s("audit"),children:"üìù Audit"}),e.jsx("button",{onClick:()=>s("complet"),children:"üì¶ Export complet"})]})]})};function $e(){const[l,s]=m.useState("dashboard"),[r,a]=m.useState(()=>P.getAccessToken());m.useEffect(()=>{a(P.getAccessToken())},[]);const t=m.useMemo(()=>!!r,[r]),i=async()=>{try{await P.signIn(),a(P.getAccessToken())}catch(h){console.error("Connexion Google √©chou√©e:",h)}},u=async()=>{try{await P.signOut()}catch(h){console.warn("D√©connexion: avertissement:",h)}finally{a(null),s("dashboard")}},n=new Set(["participation","resultats","passage-t2","sieges","exports","admin"]);m.useEffect(()=>{!t&&n.has(l)&&s("dashboard")},[t,l]);const c=()=>e.jsx("div",{className:"page-container",style:{padding:"1rem"},children:e.jsxs("div",{className:"card",style:{maxWidth:720,margin:"0 auto",padding:"1rem"},children:[e.jsx("h2",{style:{marginTop:0},children:"Connexion requise"}),e.jsx("p",{children:"Pour acc√©der aux saisies et aux donn√©es (Google Sheets), vous devez vous connecter avec le compte Google autoris√©."}),e.jsx("button",{className:"action-btn primary",onClick:i,children:"Se connecter avec Google"})]})}),d=()=>{switch(l){case"dashboard":return e.jsx(Q,{onNavigate:s});case"participation":return t?e.jsxs("div",{className:"page-container",children:[e.jsx(oe,{}),e.jsx(ce,{}),e.jsx(de,{})]}):c();case"resultats":return t?e.jsxs("div",{className:"page-container",children:[e.jsx(xe,{}),e.jsx(me,{}),e.jsx(pe,{}),e.jsx(je,{})]}):c();case"passage-t2":return t?e.jsxs("div",{className:"page-container",children:[e.jsx(ve,{}),e.jsx(ge,{})]}):c();case"sieges":return t?e.jsxs("div",{className:"page-container",children:[e.jsx(Ce,{}),e.jsx(ye,{})]}):c();case"exports":return t?e.jsxs("div",{className:"page-container",children:[e.jsx(Pe,{}),e.jsx(Ve,{})]}):c();case"admin":return t?e.jsxs("div",{className:"page-container",children:[e.jsx(Ie,{}),e.jsx(Re,{}),e.jsx(Ae,{})]}):c();default:return e.jsx(Q,{onNavigate:s})}};return e.jsxs("div",{className:"app",children:[e.jsx(ne,{currentPage:l,onNavigate:s}),e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",padding:"0 1rem"},children:t?e.jsx("button",{className:"action-btn",onClick:u,children:"D√©connexion"}):e.jsx("button",{className:"action-btn primary",onClick:i,children:"Connexion Google"})}),e.jsx("main",{className:"main-content",children:d()}),e.jsx(le,{})]})}L.setupGlobalErrorHandler();B.createRoot(document.getElementById("root")).render(e.jsx(X.StrictMode,{children:e.jsx($e,{})}));
